## CH 4 汇编语言程序设计

### 汇编语言程序结构

一个完整的源程序在结构上必须做到:

- 用方式选择伪指令==说明==执行该程序的==微处理器类型==；
- 用段定义语句==定义==每一个==逻辑段==；
- 用ASSUME语句==说明段约定==；
- 用汇编结束语句==说明==源程序==结束==；

完整段定义格式

```assembly
            .586                      ；方式定义
    DATA    SEGMENT USE16             ；定义数据段
            ……
    DATA    ENDS
    
    CODE    SEGMENT USE16             ；定义代码段
            ASSUME  CS:CODE,DS:DATA   ；说明段约定 
    BEG:    MOV     AX,DATA           ；BEG为启动地址
            MOV     DS,AX
　　　　　　...... 　　　
            MOV     AH,4CH           
	     INT     21H               ；返回DOS
    CODE    ENDS
            END     BEG               ；汇编结束
```

#### 方式选择伪指令

功能：声明当前的源程序指令是哪一种CPU指令,汇编链接生成的目标程序在哪一种CPU机型上运行。

指令以句号开头, 格式和功能如下: 

. 8086               ;只汇编8086、8088指令。
. 286                  ;只汇编8086、8088及80286实模式指令
. 286P               ;只汇编8086、8088及80286全部指令
. 386                  ;同.286,且汇编80386实模式指令
. 386P               ;同.286P,且汇编80386全部指令
. 486                  ;同.386,且汇编80486实模式指令
. 486P               ;同.386P,且汇编80486全部指令
 . 586                ;同.486,且汇编80486实模式指令
. 586P               ;同.486P,且汇编80586全部指令

通常,方式选择伪指令放在程序的头部,做为第一条语句。不设置与设置.8086是等价的

#### 段定义语句

功能：逻辑段的==定界语句==,源程序中每一个逻辑段都必须用段定义语句定界。

```
段定义语句格式如下:
   段名   SEGMENT    定位参数 链接参数 ‘分类名’  段长度
         段体
   段名   ENDS
```

SEGMENT/ENDS是一对段定义语句,一个逻辑段从==SEGMENT==语句开始,到==ENDS==语句结束

段名  

命名规则和变量名及标号名一样,它==不能代表段体的性质==,但为了阅读方便,习惯上总是根据段体的性质起一个适当的段名。通常用DATA做为数据段的段名,用STACK做为堆栈段的段名,CODE为代码段的段名

##### 定位参数,链接参数,‘分类名’

> 为段定义语句的3个属性参数,可以选用1～3个,也可以全部省略

属性参数的功能：为源程序的汇编、链接提供必要的信息

- 定位参数

  通知链接程序,逻辑段的目标代码在存储器中如何存放

  1. ==BYTE==字节地址:表明该逻辑段的目标代码可以从任意地址开始依次存放;
  2. ==WORD==字地址:表示该逻辑段的目标代码,从偶地址开始依次存放
  3. ==PARA (或者缺省)==节地址:表示该逻辑段的目标代码,从一个能被16整除的地址开始依次存放
  4. ==PAGE==页地址:表示该逻辑段的目标代码,从一个能被256整除的地址开始依次存放

- 链接参数

  又称组合,通知链接程序如何将不同模块中的同名逻辑段组合成一个段

- ’分类名‘

  表示逻辑段的类别

- 段长度

  - ==USE16==:表示该逻辑段长度最大允许为64K,单元的有效地址为16位,访问该逻辑段采用16位寻址方式
  - USE32:表示该逻辑段长度可以超过64K,单元的有效地址为32位,访问该逻辑段采用32位寻址方式

#### 段约定语句

==格式==: ASSUME   段寄存器:段名,……,段寄存器:段名

==功能==: ASSUME 语句通知汇编程序,寻址逻辑段使用哪一个段寄存器

#### 汇编结束语句

```assembly
END    ;格式1，程序的启动地址标号
END    BEGIN   ;例如
```

功能 ： 通知汇编程序,源程序到此结束,用BEGIN作标号的指令是程序的启动指令

```assembly
END	   ;格式2
```

功能 :通知汇编程序,源程序到此结束。在==模块化程序的子模块==中,必须用此格式作为源程序的最后一条语句。

#### 返回DOS语句

```assembly
MOV    AH,4CH
MOV    AL,返回码   ; 不准备组织批处理文件,此条可省
INT    21H
```

### 汇编源程序的编程格式

- ==EXE文件的编程格式==：只能生成扩展为EXE的可执行文件
- ==COM文件的编程格式==：可以生成扩展为COM的可执行文件

COM文件的执行级别高于EXE文件,同名的BAT(批处理)文件执行级别最低

#### EXE文件的编程格式

- 允许源程序使用==多个==逻辑段

- 实模式下,每个逻辑段的目标块不超过64K；

- 适合编写==大型==程序


<img src="C:\Users\16711\AppData\Roaming\Typora\typora-user-images\image-20191027112650737.png" alt="image-20191027112650737" style="zoom:70%;" />

<img src="..\img\image-20191027112711895.png" alt="image-20191027112711895" style="zoom:67%;" />

#### COM文件的编程格式

- 只允许使用==一个==逻辑段,即==代码段==,不允许设置堆栈段

- ==需使用定位ORG==伪指令将程序的启动指令存放在==代码段偏移地址为100H==的单元
- 适合于编写==中小型==程序

<img src="..\img\image-20191027113054888.png" alt="image-20191027113054888" style="zoom:67%;" />



### 系统功能调用

DOS的4个组成部分中==IBMBIO.COM==和==IBMDOS.COM==是DOS系统的核心模块

- ==IBMBIO.COM==为基本I/O设备处理程序,与==BIOS==一起完成数据输入和数据输出的基本操作 
  - BIOS 一片大容量的EPROM或FLASH存储器
- ==IBMDOS.COM==是磁盘文件管理程序

这两个模块均有若干子功能可以被用户程序调用，称为“DOS功能调用”和“BIOS功能调用”(系统功能调用)

#### DOS功能调用

```assembly
;用户程序通过INT 21H软中断指令调用DOS系统功能,调用模式如下:

MOV     AH,功能号
;设置入口参数
INT     21H
;分析出口参数
;功能号：  代表一个不同功能的子程序
```

功能号

- ==01H==	等待键入一个字符,有回显,响应Ctrl_C
  - 入口参数:无。
  - 出口参数:==AL＝按键的ASCII码==。若AL＝0,表明按键是功能键,光标键,需再次调用本功能,才能返回按键的扩展码
- ==02H==    显示一个字符,响应Ctrl_C
  - 入口参数:==DL＝待显字符的ASCII码==
  - 出口参数:无
  - 该功能要破坏AL寄存器的内容
- ==07H==    等待键入一个字符,无回显,不响应Ctrl_C
  - 入口参数:无
  -  出口参数:==AL＝按键的ASCII码==,若AL＝0,需再次调用该项功能才能在AL中得到按键的扩展码
- ==08H==    等待键入一个字符,无回显,响应Ctrl_C
  - 入口参数:无
  - 出口参数:==AL＝按键的ASCII码==,若AL＝0,需再次调用该项功能才能在AL中得到按键的扩展码
- ==09H==    显示字符串,响应Ctrl_C
  - 入口参数:==DS:DX＝字符串首地址==,字符串必须以‘$'(即ASCII码24H)为结束标志
  - 出口参数:无
  - 该项功能从屏幕当前位置开始,显示字符串,遇到结束标志‘$’时停止,‘$’字符并不显示
  - 注意：9号功能破坏AL寄存器的内容

在屏幕上显示 ‘I AM A STUDENT！’

```assembly
            .486
  DATA    SEGMENT USE16                   ；定义数据段
  MESG    DB      ‘I AM A STUDENT!’,’$’
  DATA    ENDS
  CODE    SEGMENT USE16                   ；定义代码段
          ASSUME  CS:CODE,DS:DATA
  BEG:    MOV     AX,DATA
          MOV     DS,AX
  LAST:   MOV     AH,9
          MOV     DX,OFFSET MESG
          INT     21H
	      MOV	  AH,4CH           
          INT	  21H                     ；返回DOS
  CODE    ENDS
          END	  BEG
```

- ==0AH==     等待键入一串字符送用户程序数据缓冲区
  - 入口参数：==DS:DX指向放键入字符的缓冲区==
  - 出口参数：存放于缓冲区的字符串，以回车键结尾
  - 缓冲区定义的第二个字节(写入实际接收的字符个数)由系统设置，其余由用户定义
  - 若输入的字节数少于定义的字节数，缓冲区其余字节补零
  - 若输入的字节数大于定义的字节数，后来输入的字符丢弃且响铃警告。

#### BIOS功能调用

```
BIOS功能调用模式:

      MOV     AH,功能号
      设置入口参数
      INT     n
      分析出口参数

其中INT n为软中断指令,n为中断类型码
不同n的代表不同的设备驱动程序
```

键盘输入功能调用

功能号

- ==00H==    读取键入的一个字符,无回显,响应Ctrl_C,无键入则等待
  - 入口参数:无
  - 出口参数:==AL＝键入字符的ASCII码==。若AL＝0,则AH＝输入键的扩展码
- ==01H==     查询键盘缓冲区
  - 入口参数:无
  - 出口参数:
    1. Z标志＝0,表示有键入,键代码仍留在键盘缓冲区中,此时AL＝键入字符的ASCII码,AH＝键入字符的扩展码
    2. Z标志＝1,表示无键入

文本显示功能调用

功能号

- ==00H==    设置屏幕显示方式

  - 入口参数: AL＝0  40×25    黑白文本方式

  ​			     AL＝1  40×25    彩色文本方式

  ​			     AL＝2  80×25    黑白文本方式  

  ​                 AL＝3  80×25    彩色文本方式  

  - 出口参数: 无

- ==02H==    预置光标位置
  - 入口参数: BH＝显示页号,DH＝行号,DL＝列号
  - 出口参数: 无
- ==03H==    读取光标的当前位置
  - 入口参数: BH＝显示页号
  - 出口参数: CH、CL＝光标顶部扫描线、低部扫描线的行号
                     DH、DL＝光标在屏幕上的行、列号
- ==13H== 显示字符串
  - 入口参数: AL＝0～3, BH＝显示页号,BL＝属性字(AL＝0、1 时有效),
               	  CX＝串长度,DH、DL＝字符串显示的起始行、列号,
               	  ES:BP＝待显字符串首地址
  - 出口参数: 无

==13H功能是唯一能显示彩色字符的子功能==

### 程序设计方法

分支和循环程序设计