# ä¸€æ¬¡ç»™é˜¿é‡Œå·´å·´fastjsonä¿®bugçš„å­¦ä¹ ç»å†

> fastjsonä¹Ÿæ˜¯æˆ‘æœ€è¿‘æœ‰ç”¨åˆ°çš„ä¸€ä¸ªå¼€æºåº“
>
> è¿™æ˜¯æˆ‘åœ¨Bç«™å­¦ä¹ åˆ°çš„ï¼Œä¸‹é¢é™„ä¸Šè§†é¢‘é“¾æ¥

[è§†é¢‘é“¾æ¥](https://www.bilibili.com/video/av77302131)



#### æ‰¾bugæ ‡å‡†

1. bugèƒ½å¤ç°
2. bugæ¯”è¾ƒé‡è¦ï¼Œä¹Ÿå°±æ˜¯è¯´å¾ˆå¤šäººéƒ½å‡ºç°è¿‡è¿™ä¸ªbug



#### æ‰¾åˆ°bug

æ‰¾åˆ°çš„bugï¼šfastjsonæ— æ³•ååºåˆ—åŒ–è¶…å‡ºæŸç§é™åˆ¶çš„ç±»#2779  ä¸‹é¢æœ‰bugé“¾æ¥

[bugé“¾æ¥](https://github.com/alibaba/fastjson/issues/2779)

é¦–å…ˆä½¿ç”¨git clone fastjsoné¡¹ç›®ï¼Œåœ¨ideaä¸­æ‰“å¼€

è¿›å…¥teståŒ…ï¼Œå‘ç°java.alibaba.fastjson.deserializeråŒ…ä¸‹å·²ç»æœ‰issue2779çš„æµ‹è¯•ç±»äº†

å½“ç„¶ï¼Œè¿™æ˜¯upä¸»å·²ç»ä¿®å¤çš„ç‰ˆæœ¬å•¦ï¼Œæˆ‘ä»¬è¿è¡Œå‘ç°å¹¶æ²¡æœ‰æŠ¥é”™ï¼Œå“ˆå“ˆå“ˆ

#### å¤ç°bug

æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨gitå›é€€åˆ°upä¸»è¿˜æ²¡ä¿®å¤æˆåŠŸçš„ç‰ˆæœ¬

![image-20191211113613380](http://q2cgswswp.bkt.clouddn.com/blog/imgs/revertto10_29.png)

ä»–æ˜¯11.4ä¿®å¤çš„ï¼Œæˆ‘ä»¬å›é€€åˆ°ä¸‹é¢çš„10.29

åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæŠŠissue2779åŒ…é‡Œé¢çš„ä¸¤ä¸ªæ–‡ä»¶åœ¨æœ¬åœ°è¿›è¡Œä¿®æ”¹ä¸€ä¸‹ï¼ˆæŒ‰å›è½¦å¢åŠ ä¸€è¡Œå°±å¯ä»¥ï¼‰ï¼Œä»¥å…å›é€€çš„æ—¶å€™è¿™ä¸ªåŒ…ç›´æ¥æ¶ˆå¤±äº†

![](http://q2cgswswp.bkt.clouddn.com/blog/imgs/gitreset.png)

ä¸Šå›¾é€‰é”™äº†ï¼Œåº”è¯¥é€‰æ‹©Keepâ†’Reset

çœ‹åé¢çš„ä¿¡æ¯å°±å¯ä»¥çŸ¥é“ï¼Œé€‰æ‹©keepæœ¬åœ°ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆä¹Ÿå°±æ˜¯åˆšæ‰ä¿®æ”¹çš„issue2779åŒ…å†…çš„ä¸¤ä¸ªæ–‡ä»¶ï¼‰ä¼šä¿å­˜ä¸‹æ¥äº†ï¼Œå¦‚æœé€‰hardå°±ç›´æ¥æš´åŠ›åˆ é™¤å•¦

ä¹‹åè¿è¡Œissue2779æµ‹è¯•ç±»ï¼Œç»ˆäºå‡ºç°äº†æŠ¥é”™ä¿¡æ¯

![image-20191211115200184](http://q2cgswswp.bkt.clouddn.com/blog/imgs/illegal%20jump.png)

ç„¶åæ‰¾è¿™ç§jdkå’Œè¿™ä¸ªé¡¹ç›®æŠ¥é”™ä¿¡æ¯çš„äº¤ç•Œå¤„

![image-20191211115622717](http://q2cgswswp.bkt.clouddn.com/blog/imgs/more%20error%20info.png)

ä¹Ÿå°±æ˜¯com.alibaba.fastjson.parser.deserializeråŒ…ä¸‹é¢çš„ASMDeserializerFactoryç±»çš„createJavaBeanDeserializeræ–¹æ³•æœ‰é—®é¢˜

#### æŸ¥æ‰¾é—®é¢˜

æˆ‘ä»¬å®šä½åˆ°è¿™ä¸€è¡Œï¼Œè¿›è¡Œæ–­ç‚¹è°ƒè¯•

![image-20191211115948426](http://q2cgswswp.bkt.clouddn.com/blog/imgs/duandiantiaoshi.png)

æŸ¥çœ‹codeå˜é‡

![image-20191202230532915](http://q2cgswswp.bkt.clouddn.com/blog/imgs/code.png)

> codeæ˜¯ä¸€ä¸ªJavaå­—èŠ‚ç  
>
> æ‰€æœ‰çš„.class æ–‡ä»¶çš„å‰å››ä¸ªå­—èŠ‚éƒ½æ˜¯é­”æ•°ï¼Œé­”æ•°çš„å›ºå®šå€¼ä¸ºï¼š0xCAFEBABE
>
> Javaæœ‰å’–å•¡çš„æ„æ€ï¼Œç¨‹åºå‘˜çš„æµªæ¼«~
>
> é­”æ•°çš„å›ºå®šå€¼æ˜¯ Java ä¹‹çˆ¶ James Gosling åˆ¶å®šçš„ï¼Œä¸º CafeBabeï¼ˆå’–å•¡å®è´ï¼‰ï¼Œè€Œ Java çš„å›¾æ ‡ä¸ºä¸€æ¯å’–å•¡

##### Evaluate Expressionè¡¨è¾¾å¼æ±‚å€¼

åœ¨codeå¤„å³é”®æœ‰ä¸ªEvaluate Expressionï¼Œè¡¨è¾¾å¼æ±‚å€¼

![image-20191202230841162](http://q2cgswswp.bkt.clouddn.com/blog/imgs/evaluate%20expression.png)

å°†å­—èŠ‚ç è¾“å‡ºåˆ°æ–‡ä»¶bad.class

![image-20191202231109760](http://q2cgswswp.bkt.clouddn.com/blog/imgs/evaluate-writefile.png)

å¯ä»¥çœ‹åˆ°é¡¹ç›®è¿™é‡Œå‡ºç°äº†bad.classæ–‡ä»¶

![image-20191211120602606](http://q2cgswswp.bkt.clouddn.com/blog/imgs/badclassloca.png)

å¾ˆå¥‡æ€ªï¼Œæˆ‘è¿™é‡Œideaå±…ç„¶è¿˜æ˜¯å¯ä»¥åç¼–è¯‘æˆåŠŸ

![image-20191211120750776](http://q2cgswswp.bkt.clouddn.com/blog/imgs/fanbianyibad.png)

å¦‚æœæ˜¯åçš„ï¼Œideaæ— æ³•åç¼–è¯‘ï¼Œä¼šå‡ºç°ä¸‹é¢çš„ç»“æœï¼Œè§†é¢‘ä¸­æ˜¯è¿™æ ·çš„

![image-20191202234253689](http://q2cgswswp.bkt.clouddn.com/blog/imgs/badclass.png)

æˆ‘ä»¬å¯ä»¥ç”¨ä¸€äº›å·¥å…·æ¥æŸ¥çœ‹è¿™ä¸ªåçš„å­—èŠ‚ç æ–‡ä»¶

ä¾‹å¦‚ä¸‹é¢çš„å‘½ä»¤

```shell
javap -v bad #Javaè‡ªå¸¦çš„åç¼–è¯‘å·¥å…·
```

ä½†æ˜¯å¤ªé•¿äº†ï¼Œåœ¨å‘½ä»¤è¡Œçœ‹ä¹Ÿä¸å¤ªæ–¹ä¾¿

æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„å·¥å…·classpy

##### åç¼–è¯‘å·¥å…·classpy

åœ¨GitHubæœç´¢classpyï¼Œcloneä¸‹æ¥ï¼ŒæŒ‰ç…§readmeå®‰è£…è¿è¡Œ

æˆ‘æ˜¯Windowsç³»ç»Ÿï¼Œé¦–å…ˆè¿›å…¥classpyç›®å½•ä¸‹ï¼Œç‚¹å‡»è¿è¡Œäº†gradlew.batæ–‡ä»¶ï¼Œç„¶ååœ¨å½“å‰ç›®å½•ä¸‹çš„å‘½ä»¤è¡Œè¾“å…¥ä¸‹é¢çš„å‘½ä»¤å¯åŠ¨è¿™ä¸ªå·¥å…·

```shell
gradle run
```



è§†é¢‘ä¸­ä»–çš„Javaç‰ˆæœ¬ä¸º11ï¼Œå¯åŠ¨å¤±è´¥äº†

ä½¿ç”¨äº†jenvå‘½ä»¤åˆ‡æ¢åˆ°jdk1.8ï¼Œæˆ‘ä½¿ç”¨çš„å°±æ˜¯jdk1.8  å¿½ç•¥è¿™ä¸ªæ­¥éª¤

```shell
jenv shell 1.8  #éœ€è¦å®‰è£…jenv
```



ä¸‹é¢æ˜¯æ‰“å¼€çš„å­—èŠ‚ç æ–‡ä»¶

![image-20191203001137874](http://q2cgswswp.bkt.clouddn.com/blog/imgs/classpybadclass.png)



ç”±äºæˆ‘ä»¬åªæœ‰Illegal target of jump or branchè¿™ä¸ªæŠ¥é”™ä¿¡æ¯ï¼Œè¿™ä¸€ä¸ªçº¿ç´¢



> ä¸‹é¢buildjdkæ“ä½œå¤ªç¡¬æ ¸ï¼Œæˆ‘æ²¡æœ‰è·Ÿç€åšğŸ˜‚  æ„Ÿå…´è¶£å¯ä»¥å»è§†é¢‘16:45å¤„çœ‹çœ‹ğŸ‘

åˆ°jdkä¸­å¯»æ‰¾æ­¤æŠ¥é”™ä¿¡æ¯

clone openjdkä¸‹çš„jdké¡¹ç›®ï¼Œå…¨å±€æœç´¢æ­¤æŠ¥é”™ä¿¡æ¯Illegal target of jump or branch 

![Illegal target of jump or branch æŠ¥é”™ä¿¡æ¯](http://q2cgswswp.bkt.clouddn.com/blog/imgs/errorInfoLocaInJDK.png)

 ç„¶åä»–ä¿®æ”¹äº†jdkï¼Œä¸Šé¢å›¾ç‰‡ä¸­çš„ä»£ç å°±æ˜¯ä¿®æ”¹åçš„jdkï¼ŒåŸæ¥åªæœ‰æŠ¥é”™ä¿¡æ¯ï¼Œä»–è‡ªå·±åŠ ä¸Šäº†jumpå’Œtargetï¼Œå¯ä»¥æç¤ºé”™è¯¯çš„ä½ç½®ï¼Œå¦‚ä¸‹å›¾

![image-20191211131058621](http://q2cgswswp.bkt.clouddn.com/blog/imgs/changeJDK.png)

ç„¶åä»–è‡ªå·±buildäº†ä¸€ä¸ªjdkğŸ‘

ä½¿ç”¨è‡ªå·±buildçš„jdké‡æ–°è¿è¡Œissue2779ï¼Œä¸‹é¢æ˜¯æŠ¥é”™ä¿¡æ¯ï¼Œdeserialzeæ–¹æ³•ç¬¬50ä½ç½®

![image-20191211131737775](http://q2cgswswp.bkt.clouddn.com/blog/imgs/errorInJDK.png)

åœ¨åˆšæ‰classpyæ‰“å¼€çš„bad.classä¸­æ‰¾åˆ°deserialzeæ–¹æ³•  å­—èŠ‚ç   ç¬¬50ä¸ªä½ç½®æ˜¯è¿™æ ·çš„

![image-20191211124952950](http://q2cgswswp.bkt.clouddn.com/blog/imgs/bytecode_50.png)

```
ifeq -32405 
```

å¯èƒ½æ˜¯æº¢å‡º

æŸ¥çœ‹ifeqçš„å«ä¹‰ï¼Œå½“æ ˆé¡¶intå‹æ•°å€¼ç­‰äº0æ—¶è·³è½¬

![image-20191211132443946](http://q2cgswswp.bkt.clouddn.com/blog/imgs/ifeq.png)

fastjsonæœ‰ä¸ªåœ°æ–¹ä»£ç æ²¡æœ‰å†™å¥½ï¼Œç”Ÿæˆäº†ä¸€ä¸ªä¼šæº¢å‡ºçš„è·³è½¬æŒ‡ä»¤

ç„¶åæ ¹æ®ä¸Šä¸‹æ–‡(50ä½ç½®ä¸Šé¢æœ‰ä¸ªisEnabled)ï¼Œåœ¨æºç ä¸­æ‰¾åˆ°ç›¸åº”ä½ç½®

![image-20191211125555537](http://q2cgswswp.bkt.clouddn.com/blog/imgs/errorloca.png)

è¿›å…¥visitJumpInsnæ–¹æ³•ï¼Œè¿™å…¶å®æ˜¯asmä»£ç ï¼ˆæ“ä½œå­—èŠ‚ç çš„åº“ï¼‰

![image-20191211133402454](http://q2cgswswp.bkt.clouddn.com/blog/imgs/asmInterf.png)

æŒ‰crtl+alt+Bå¯ä»¥è¿›å…¥æ¥å£çš„å®ç°ç±»

![image-20191211133434998](http://q2cgswswp.bkt.clouddn.com/blog/imgs/asmImpl.png)



#### è§£å†³é—®é¢˜

ç„¶åä»–è§‰å¾—ï¼Œå¯èƒ½æ˜¯fastjsoné‡Œé¢çš„asmä»£ç ç‰ˆæœ¬å¤ªè€äº†ï¼Œæƒ³æŠŠæœ€æ–°çš„åˆå¹¶è¿›æ¥ï¼Œä½†æ˜¯ç”±äºç‰ˆæœ¬ç›¸å·®7å¹´ï¼Œå¤±è´¥äº†

å¯¹æ¯”æœ€æ–°çš„asmä»£ç ä¸fastjsoné‡Œé¢çš„ä»£ç 

![image-20191211133753383](http://q2cgswswp.bkt.clouddn.com/blog/imgs/changeCode.png)

è¿™é‡Œéå¸¸é‡è¦ï¼Œå¦‚æœè¶Šç•Œï¼Œå¯ä»¥å°†IFxxxæ”¹ä¸ºIFNOTxxx  GOTO_W

![image-20191211175328263](http://q2cgswswp.bkt.clouddn.com/blog/imgs/annotation.png)

æœ€åè§£å†³çš„é—®é¢˜ï¼šæŒ‰ç…§asmçš„è¦æ±‚ï¼ŒæŠŠä¸€ä¸ªä¸æ”¯æŒé•¿è·³è½¬çš„ifeqè½¬å˜æˆifnqåŠ goto_wé•¿è·³è½¬è¯­å¥

[pré“¾æ¥](https://github.com/alibaba/fastjson/pull/2858)



ä¿®å®Œbugä¸€å®šè¦è¡¥ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼





#### è§†é¢‘ä¸­æåˆ°å…¶ä»–å†…å®¹

##### å­—èŠ‚ç çš„è§£é‡Šï¼š

ç®€å•å†™ä¸€ä¸ªæµ‹è¯•ä¸€ä¸‹

```Java
public class AbcDTO {
    public static void main(String [] args) {
        int i =1,j=2;
        if (i+j==3){
            System.out.println("3");
        }else {
            System.out.println("0");
        }
    }
```

ç¼–è¯‘è¿è¡Œï¼Œä½¿ç”¨ASM Bytecode Vieweræ’ä»¶æŸ¥çœ‹å­—èŠ‚ç 

##### ASM Bytecode Vieweræ’ä»¶

å¯åœ¨idea Pluginsä¸­å®‰è£…

![image-20191208144452139](http://q2cgswswp.bkt.clouddn.com/blog/imgs/asmplugin.png)

æ‰¾åˆ°mainæ–¹æ³•

![image-20191208144825554](http://q2cgswswp.bkt.clouddn.com/blog/imgs/JavaBytecode.png)

æ¯ä¸ªæ–¹æ³•é‡Œé¢æœ‰ä¸ªæ“ä½œæ•°æ ˆï¼Œjvmæ‰§è¡Œæ–¹æ³•æ—¶ä¼šä¸åœçš„æ‰§è¡Œè¿™äº›æŒ‡ä»¤





##### ä¿®bugè¦æŒæ¡çš„ä¸œè¥¿

1. èƒ½ä»ç”¨æˆ·æä¾›çš„bugï¼Œé‡ç°bug
2. çœ‹æ ˆè½¨è¿¹ï¼Œå­—èŠ‚ç é—®é¢˜å‡ºåœ¨å“ªé‡Œ
3. å­¦ä¹ ä½¿ç”¨åç¼–è¯‘å·¥å…·
4. é”™è¯¯ä¿¡æ¯åˆ°åº•æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Œè¯»jdkæºç ï¼ˆç”šè‡³éœ€è¦build jdkï¼‰



Rå¤§çš„ä¹¦å•RednaxelaFX

ä¸‹Â·

##### mybatiséœ€è¦æŒæ¡çš„å†…å®¹

1. #{} ${}
2. ç¼“å­˜æ˜¯å’‹å®ç°çš„ï¼Ÿ
3. Executoræ˜¯å•¥ï¼Ÿ
4. åˆ†é¡µæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ



#### æ€»ç»“ä¸€ä¸‹çœ‹è¿™ä¸ªè§†é¢‘äº†è§£åˆ°çš„å†…å®¹

- Javaå­—èŠ‚ç çš„magic number  Cofe Babe

- ideaçš„è¡¨è¾¾å¼è®¡ç®—Evaluate Expression

- å­¦ä¹ ä½¿ç”¨åç¼–è¯‘å·¥å…·javap -v ã€classpy

- ASM Bytecode Vieweræ’ä»¶æŸ¥çœ‹å­—èŠ‚ç 

- è¯è¯´æˆ‘æ‰åˆšçŸ¥é“ideaä¸­å¿«æ·é”®CTRL+Alt+Bå¯ä»¥ä»æ¥å£è·³è½¬åˆ°å®ç°ç±»ğŸ˜‚ç„¶åCtrl+Uæ˜¯å®ç°ç±»åˆ°æ¥å£ğŸ¤£

- GitHubä¸­çš„issueä»¥åŠpull request

  